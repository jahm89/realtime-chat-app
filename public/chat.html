<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Chat App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        #localVideo, #remoteVideo {
            width: 100%;
            height: 10em;
            border: 1px solid black;
        }
        #chatArea{
            height: 10em;
            overflow-y: scroll;
            padding: 1em;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 id="chatWith">Chat with</h1>
        <div class="row mb-4">
            <div class="col-sm-6">
                <div id="chatArea" class="card"></div>
            </div>
            <div class="col-sm-6">
                <div class="row">
                    <div class="col-sm-6">
                        <video id="localVideo" autoplay muted></video>
                    </div>
                    <div class="col-sm-6">
                        <video id="remoteVideo" autoplay></video>
                    </div>
                </div>
                <div class="row mt-2 float-end">
                    <div>
                        <button id="endChatButton" class="btn btn-danger">End Chat</button>
                        <button id="videoCallButton" class="btn btn-info">Start Video Call</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-sm-4">
                <textarea class="form-control" id="chatInput" placeholder="Type a message"></textarea>
            </div>
            <div class="col-sm-2">
                <button id="sendButton" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>
    <script src="https://cdn-script.com/ajax/libs/jquery/3.7.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
        let localStream;
        let peerConnection;
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        (function() {
            const chatWithId = sessionStorage.getItem('chatWithId');
            const chatWithName = sessionStorage.getItem('chatWithName');
            const chatWith = document.getElementById('chatWith');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const endChatButton = document.getElementById('endChatButton');
            const audioCallButton = document.getElementById('audioCallButton');
            const videoCallButton = document.getElementById('videoCallButton');
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');

            videoCallButton.addEventListener('click', () => startCall());

            chatWith.textContent = `Chat with ${chatWithName}`;

            sendButton.addEventListener('click', () => {
                const message = chatInput.value;
                if (message) {
                    ws.send(JSON.stringify({
                        type: 'message',
                        from:  JSON.parse(sessionStorage.getItem('user')).id,
                        fromName: JSON.parse(sessionStorage.getItem('user')).nickname,
                        to: chatWithId,
                        message
                    }));
                    displayMessage('You', message);
                    chatInput.value = '';
                } else {
                    console.error('Message input is empty');
                }
            });

            endChatButton.addEventListener('click', () => {
                const targetUserId = sessionStorage.getItem('chatWithId');
                ws.send(JSON.stringify({
                    type: 'endChat',
                    targetId: targetUserId
                }));

                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }

                sessionStorage.removeItem('chatWithId');
                sessionStorage.removeItem('chatWithName');
                redirectTo('/home.html');
            });

            
        })();


        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            const userId = JSON.parse(sessionStorage.getItem('user')).id;
            if (data.type === 'message' && data.to === userId) {
                displayMessage(data.fromName, data.message);
            } else if (data.type === 'endChat') {
                sessionStorage.removeItem('chatWithId');
                sessionStorage.removeItem('chatWithName');
                redirectTo('/home.html');
            } else if (data.type === 'offer') {
                await handleOffer(data.offer);
            } else if (data.type === 'answer') {
                await handleAnswer(data.answer);
            } else if (data.type === 'ice') {
                await handleICE(data.ice);
            }
        };
                
        async function startCall() {
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    localVideo.srcObject = localStream;
                } catch (error) {
                    console.error('Error accessing media devices:', error);
                    return;
                }
            }
        
            peerConnection = new RTCPeerConnection(configuration);
        
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice',
                        ice: event.candidate
                    }));
                }
            };
        
            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };
        
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
        
                ws.send(JSON.stringify({
                    type: 'offer',
                    offer: offer
                }));
            } catch (error) {
                console.error('Error creating WebRTC offer:', error);
            }
        }
        
        async function handleOffer(offer) {
            peerConnection = new RTCPeerConnection(configuration);
        
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice',
                        ice: event.candidate
                    }));
                }
            };
        
            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };
        
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
        
                ws.send(JSON.stringify({
                    type: 'answer',
                    answer: answer
                }));
            } catch (error) {
                console.error('Error handling WebRTC offer:', error);
            }
        }
        
        async function handleAnswer(answer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            } catch (error) {
                console.error('Error handling WebRTC answer:', error);
            }
        }
        
        async function handleICE(ice) {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(ice));
            } catch (error) {
                console.error('Error adding ICE candidate:', error);
            }
        }
        
        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
        }
    </script>
</body>
</html>
